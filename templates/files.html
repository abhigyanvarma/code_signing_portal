{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-1">Files</h2>
  <a href="{{ url_for('verify_integrity_page') }}" class="btn btn-outline-secondary btn-sm">
    Verify Integrity
  </a>
</div>

<!-- Upload -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h5 class="fw-semibold mb-3">Upload Files</h5>
    <form action="{{ url_for('files_upload') }}" method="post" enctype="multipart/form-data" class="d-flex flex-column flex-md-row gap-2">
      <input class="form-control" type="file" name="files" multiple required>
      <button class="btn btn-dark">Upload</button>
    </form>
  </div>
</div>

<!-- Unsigned Files -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h5 class="fw-semibold mb-3">Pending Uploads</h5>
    {% set pending = files | selectattr("status", "equalto", "uploaded") | list %}
    {% if pending %}
      <form method="post" action="{{ url_for('files_page') }}">
        <div class="mb-3">
          <label class="form-label small text-muted">Select Certificate</label>
          <select name="cert_id" class="form-select" required>
            {% for c in certs %}
              <option value="{{ c._id }}">
                {{ c.cn }} â€” [{{ c.algo or 'RSA' }}], valid till {{ c.valid_to }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <input class="form-control" name="pfx_password" type="password" placeholder="Enter PFX password" required>
        </div>
        <div class="mb-3">
          {% for f in pending %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="selected_files" value="{{ f.filename }}">
              <label class="form-check-label">{{ f.filename }}</label>
            </div>
          {% endfor %}
        </div>
        <button class="btn btn-success">Sign Selected</button>
      </form>
    {% else %}
      <p class="text-muted">No unsigned files pending.</p>
    {% endif %}
  </div>
</div>

<!-- Signed Files -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h5 class="fw-semibold mb-3">Signed Files</h5>
    {% set signed_files = files | selectattr("status", "equalto", "signed") | list %}
    {% if signed_files %}
      <div class="table-responsive">
        <table class="table align-middle table-hover">
          <thead class="table-light">
            <tr>
              <th>Filename</th>
              <th>Uploaded By</th>
              <th>Uploaded At</th>
              <th>Cert CN</th>
              <th>Algorithm</th>
              <th>Checksum Original</th>
              <th>Checksum Signed</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for f in signed_files %}
              <tr>
                <td>{{ f.filename }}</td>
                <td>{{ f.uploader }}</td>
                <td>{{ f.uploaded_at }}</td>
                <td>{{ f.cert_cn or 'N/A' }}</td>
                <td>{{ f.algo or 'RSA' }}</td>
                <td>{{ f.checksum_original[:12] ~ '...' if f.checksum_original else 'N/A' }}</td>
                <td>{{ f.checksum_signed[:12] ~ '...' if f.checksum_signed else 'N/A' }}</td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('download_upload', filename=f.filename) }}" class="btn btn-outline-dark">Download</a>
                    <form method="post" action="{{ url_for('files_verify') }}" class="d-inline">
                      <input type="hidden" name="selected_files" value="{{ f.filename }}">
                      <button type="submit" class="btn btn-outline-success">Verify</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No signed files yet.</p>
    {% endif %}
  </div>
</div>

{% endblock %}
